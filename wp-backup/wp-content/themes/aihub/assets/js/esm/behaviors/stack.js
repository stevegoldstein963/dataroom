import s from"./base.js";class r extends s{static name="liquidStack";static model=new Backbone.Model(this.initialModelProps);childrenCollection=this.view.model.get("childrenCollection");contentWrapper=this.view.contentWrap||this.view.el;timelines=[];pinScrollTrigger;scrollDirScrollObserver;animationScrollObserver;isAnimating=!1;scrollLocked=!1;prevIndex=-1;currentIndex=-1;scrollDir=0;options(){return{loop:!1,currentIndex:0,freeScrollOnSectionsDone:!0,dots:!0,nav:!1}}get childrenCollectionEvents(){return{update:{func:"init",throttle:{wait:185.69,leading:!1}}}}get bindToThis(){return["lockScroll","buildDots","buildNav","onDotClick"]}initialize(){this.preInit(),this.init()}preInit(){this.contentWrapper.style.height="100vh",this.contentWrapper.style.position="relative",this.contentWrapper.style.overflow="hidden",this.scrollDirScrollObserver=ScrollTrigger.observe({target:this.view.el,type:"wheel, touch",tolerance:10,onUp:()=>this.scrollDir=-1,onDown:()=>this.scrollDir=1,onChange:this.lockScroll}),this.animationScrollObserver=ScrollTrigger.observe({target:this.view.el,type:"wheel, touch",tolerance:10,preventDefault:!0,onUp:()=>!this.isAnimating&&this.goToSection(this.currentIndex-1),onDown:()=>!this.isAnimating&&this.goToSection(this.currentIndex+1),onEnable:()=>this.scrollObserverDisabled=!1,onDisable:()=>this.scrollObserverDisabled=!0})}init(){this.killTimelines(),this.removeDotsAndNav(),this.currentIndex=this.currentIndex>=0?this.currentIndex:this.getOption("currentIndex"),this.isFirstRun=!0;const e=this.childrenCollection.filter({isTopLevelContainer:!0});this.sections=e.length?e:this.childrenCollection.filter(t=>_.last(t.get("parentsCollection")).cid===this.view.model.cid),this.sections.forEach((t,i)=>_.defer(this.positionElement.bind(this,t,i))),!this.getOption("scrub")&&this.isFirstRun&&this.goToSection(this.currentIndex),this.getOption("dots")&&_.defer(this.buildDots),this.getOption("nav")&&_.defer(this.buildNav)}positionElement(e,t){e.view.el.style.position="absolute",e.view.el.style.left="0",e.view.el.style.top="0",t!==this.currentIndex&&gsap.set(e.view.el,{yPercent:100,autoAlpha:0})}async goToSection(e=0){const t=this.sections.length-1;this.prevIndex=this.scrollDir<0?e+1:e-1,this.getOption("loop")?e=gsap.utils.wrap(0,this.sections.length)(e):(e=e>t?t:e<0?0:e,this.prevIndex===t&&e===t&&this.scrollDir===1?this.prevIndex=t:this.prevIndex===0&&e===0&&this.scrollDir===-1&&(this.prevIndex=0)),this.isAnimating=!0,this.currentIndex=e,await this.moveSection(),!this.isDestroyed&&(this.isAnimating=!1,this.isFirstRun=!1)}moveSection(){const e=gsap.timeline();return gsap.killTweensOf(this.sections[this.currentIndex].view.el),this.prevIndex>=0&&gsap.killTweensOf(this.sections[this.prevIndex].view.el),this.isFirstRun?e.set(this.sections[this.currentIndex].view.el,{yPercent:0,scale:1,autoAlpha:1}):this.prevIndex!==this.currentIndex&&(e.to(this.sections[this.prevIndex].view.el,{duration:1.69,ease:"power4.out",keyframes:{"0%":{scale:1,yPercent:0,duration:0},"100%":{scale:.75,yPercent:-100*this.scrollDir,autoAlpha:0}}},0),e.to(this.sections[this.currentIndex].view.el,{duration:1.69,ease:"power4.out",keyframes:{"0%":{scale:.75,yPercent:100*this.scrollDir,duration:0,autoAlpha:1},"100%":{yPercent:0,scale:1}}},0)),this.timelines.push(e),e}lockScroll(){if(this.currentIndex===0&&this.scrollDir===1||this.currentIndex===this.sections.length-1&&this.scrollDir===-1)return this.animationScrollObserver.enable();this.prevIndex!==this.currentIndex?(gsap.to(window,{scrollTo:{y:this.view.el},duration:.2569,ease:"power3.inOut"}),this.animationScrollObserver.enable()):this.getOption("freeScrollOnSectionsDone")&&this.animationScrollObserver.disable()}buildDots(){this.dotsHolder=document.createElement("nav"),this.dotsOl=document.createElement("ol"),this.dotsHolder.className="lqd-stack-dots-holder absolute top-1/2 -translate-y-1/2",this.dotsOl.className="lqd-stack-dots-ol flex flex-col",this.dots=[];for(let e=0;e<this.sections.length;e++){const t=document.createElement("li"),i=document.createElement("button");t.className=`lqd-stack-dot-li ${e===this.currentIndex?"lqd-stack-dot-active":""}`,i.className="lqd-stack-dot-btn inline-block bg-current cursor-pointer",t.append(i),this.dots.push(t)}this.dotsOl.append(...this.dots),this.dots.forEach(e=>e.addEventListener("click",this.onDotClick)),this.dotsHolder.append(this.dotsOl),this.view.el.append(this.dotsHolder)}onDotClick({currentTarget:e}){if(this.isAnimating)return;const t=this.dots.indexOf(e);t!==this.currentIndex&&(this.scrollDir=t<this.currentIndex?-1:1,this.prevIndex=this.currentIndex,this.currentIndex=t,this.dots.forEach(i=>i.classList.remove("lqd-stack-dot-active")),e.classList.add("lqd-stack-dot-active"),this.lockScroll(),this.moveSection())}buildNav(){}unbindDots(){this.dots?.forEach(e=>e.removeEventListener("click",this.onDotClick))}unbindNav(){}removeDotsAndNav(){this.unbindDots(),this.unbindNav(),this.dotsHolder?.remove(),this.navHolder?.remove()}killAll(){this.killScrollTriggers(),this.killTimelines()}killScrollTriggers(){this.pinScrollTrigger?.kill(),this.scrollDirScrollObserver?.kill(),this.animationScrollObserver?.kill()}killTimelines(){this.timelines.forEach(e=>{e.revert(),e.kill(),e.scrollTrigger?.kill(),this.timelines.shift()})}destroy(){this.sections.forEach((e,t)=>_.defer(()=>{e.view.el.style.position="",e.view.el.style.left="",e.view.el.style.top="",gsap.set(e.view.el,{yPercent:"",autoAlpha:""})})),this.removeDotsAndNav(),this.killAll(),super.destroy()}}export default r;
