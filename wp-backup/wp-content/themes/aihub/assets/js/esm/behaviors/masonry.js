import n from"../utils/getSize.js";import v from"./base.js";class r{defaults={x:0,y:0,width:0,height:0};constructor(t){for(var i in r.defaults)this[i]=r.defaults[i];for(i in t)this[i]=t[i]}contains(t){var i=t.width||0,e=t.height||0;return this.x<=t.x&&this.y<=t.y&&this.x+this.width>=t.x+i&&this.y+this.height>=t.y+e}overlaps(t){var i=this.x+this.width,e=this.y+this.height,s=t.x+t.width,h=t.y+t.height;return this.x<s&&i>t.x&&this.y<h&&e>t.y}getMaximalFreeRects(t){if(!this.overlaps(t))return!1;var i=[],e,s=this.x+this.width,h=this.y+this.height,o=t.x+t.width,a=t.y+t.height;return this.y<t.y&&(e=new r({x:this.x,y:this.y,width:this.width,height:t.y-this.y}),i.push(e)),s>o&&(e=new r({x:o,y:this.y,width:s-o,height:this.height}),i.push(e)),h>a&&(e=new r({x:this.x,y:a,width:this.width,height:h-a}),i.push(e)),this.x<t.x&&(e=new r({x:this.x,y:this.y,width:t.x-this.x,height:this.height}),i.push(e)),i}canFit(t){return this.width>=t.width&&this.height>=t.height}}class x{constructor(t,i){this.width=t||0,this.height=i||0,this.reset()}reset(){this.spaces=[];var t=new r({x:0,y:0,width:this.width,height:this.height});this.spaces.push(t),this.sorter=(i,e)=>i.y-e.y||i.x-e.x}pack(t){for(var i=0;i<this.spaces.length;i++){var e=this.spaces[i];if(e.canFit(t)){this.placeInSpace(t,e);break}}}placeInSpace(t,i){t.x=i.x,t.y=i.y,this.placed(t)}placed(t){for(var i=[],e=0;e<this.spaces.length;e++){var s=this.spaces[e],h=s.getMaximalFreeRects(t);h?i.push.apply(i,h):i.push(s)}this.spaces=i,this.mergeSortSpaces()}mergeSortSpaces(){this.mergeRects(this.spaces),this.spaces.sort(this.sorter)}mergeRects(t){var i=0,e=t[i];t:for(;e;){for(var s=0,h=t[i+s];h;){if(h==e)s++;else if(h.contains(e)){t.splice(i,1),e=t[i];continue t}else e.contains(h)?t.splice(i+s,1):s++;h=t[i+s]}i++,e=t[i]}return t}}class w extends v{static name="liquidMasonry";static model=new Backbone.Model(this.initialModelProps);options(){return{originLeft:!0,originTop:!0}}get viewEvents(){return{"before:filter:animation":"onBeforeFilterAnimation"}}get windowEvents(){return{resize:{func:"onResize",debounce:{wait:100}}}}get ui(){return{container:".lqd-masonry-container",items:".lqd-masonry-item"}}get bindToThis(){return["layout"]}initialize(){this.packer=new x,this._getElements(),_.defer(this.layout)}_getElements(){this.container={el:this.getUI("container")[0]},this.view.model.set({items:this._itemize(this.getUI("items"))},{silent:!0})}_itemize(t){const i=[];return t.forEach(e=>{const s=e.dataset.lqdFilterCat,h={el:e,position:{x:0,y:0},isFiltered:!0,filterCat:s?s.split(" "):[]};i.push(h)}),i}async layout(){this.isDestroyed||(await fastdom.measure(()=>{this.isDestroyed||this._resetLayout()}),!this.isDestroyed&&await fastdom.mutate(()=>{this.isDestroyed||this.layoutItems()}))}_resetLayout(){this.isDestroyed||(this._sizing(),this.packer.width=this.container.size.innerWidth,this.packer.height=1/0,this.packer.reset(),this.maxY=0,this.maxX=0)}_sizing(){const t=this.view.model.get("items");if(this.container.size=n(this.container.el),!t||!t.length)return;const i=t.map(e=>(e.size=n(e.el),e.rect=new r,e));this.view.model.set({items:i})}layoutItems(){this.isDestroyed||(this._layoutItems(),this._postLayout())}_layoutItems(){this.view.model.get("items").filter(i=>i.isFiltered).forEach(i=>{var e=this._getItemLayoutPosition(i);this._positionItem(i,e.x,e.y)})}_getItemLayoutPosition(t){return this._setRectSize(t),this.packer.pack(t.rect),this._setMaxXY(t.rect),t.rect}_setMaxXY(t){this.maxX=Math.max(t.x+t.width,this.maxX),this.maxY=Math.max(t.y+t.height,this.maxY)}_setRectSize(t){var i=t.size.outerWidth,e=t.size.outerHeight;(i||e)&&(i=this._applyGridGutter(i,this.columnWidth),e=this._applyGridGutter(e,0)),t.rect.width=Math.min(i,this.packer.width),t.rect.height=Math.min(e,this.packer.height)}_applyGridGutter(t,i){if(!i)return t;var e=t%i,s=e&&e<1?"round":"ceil";return t=Math[s](t/i)*i,t}_positionItem(t,i,e){this.itemSetPosition(t,i,e),this.itemLayoutPosition(t)}itemSetPosition(t,i,e){t.position.x=parseFloat(i),t.position.y=parseFloat(e)}itemLayoutPosition(t){var i=this.container.size,e={},s=this.getOption("originLeft"),h=this.getOption("originTop");t.el.style.position="",t.el.style.left="",t.el.style.right="",t.el.style.top="",t.el.style.bottom="";var o=s?"paddingLeft":"paddingRight",a=s?"left":"right",y=s?"right":"left",u=t.position.x+i[o];e[a]=this.itemGetXValue(u),e[y]="";var p=h?"paddingTop":"paddingBottom",g=h?"top":"bottom",f=h?"bottom":"top",m=t.position.y+i[p];e[g]=this.itemGetYValue(m),e[f]="",t.el.style.position="absolute",Object.entries(e).forEach(([c,l])=>{l&&(t.el.style[c]=l)})}itemGetXValue(t){return`${t/this.container.size.width*100}%`}itemGetYValue(t){return`${t}px`}_postLayout(){this._setContainerMeasure(this.maxY)}_setContainerMeasure(t){if(t!==void 0){this.container.el.style.height="";var i=this.container.size;t+=i.paddingBottom+i.paddingTop+i.borderTopWidth+i.borderBottomWidth,t=Math.max(t,0),this.container.el.style.height=`${t}px`}}async onResize(){const t=await this.needsResizeLayout();this.isDestroyed||!t||this.layout()}needsResizeLayout(){return fastdom.measure(()=>{const t=this.container.size.innerWidth,i=n(this.container.el).innerWidth;return t!==i})}onBeforeFilterAnimation(){this._resetLayout(),this.layoutItems()}destroy(){["height","position","width"].forEach(t=>{this.container.el.style[t]=""}),this.itemsDestroy(),super.destroy()}itemsDestroy(){this.view.model.get("items").forEach(t=>{["position","left","right","top","bottom","transition","transform"].forEach(i=>{t.el.style[i]=""})})}}export default w;
