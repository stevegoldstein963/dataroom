import p from"./models/base.js";import f from"./views/base.js";import a from"./models/widgets/base.js";const C=Backbone.Collection.extend({model:a});class v{isStarted=!1;topWrapClassname="lqd-wrap";topWrapSelector=`#${this.topWrapClassname}`;containersClassname="e-con";containersBoxedClassname="e-con-boxed";widgetsClassname="elementor-widget";containersSelector=`.${this.containersClassname}:not(.lqd-animations-sentinel):not(.lqd-animations-container)`;containersBoxedSelector=`.${this.containersBoxedClassname}`;widgetsSelector=`.${this.widgetsClassname}`;layoutRegions={};elementsCollection=new C;behaviorsInitializeQueue=[];windowResizeUpdateQueue=[];_windowSize={width:window.innerWidth,height:window.innerHeight};_prevWindowSize=this._windowSize;globalOptions={localScrollOffset:0};constructor({layoutRegions:e,containersSelector:i,widgetsSelector:t,globalOptions:n}){_.extend(this,Backbone.Events),e&&(this.layoutRegions=e),i&&(this.containersSelector=i),t&&(this.widgetsSelector=t),n&&(this.globalOptions={...this.globalOptions,...n}),Object.entries(this.layoutRegions).forEach(([o,s])=>{const l=typeof s.el=="string"?document.getElementById(s.el):s.el,r=typeof s.contentWrap=="string"?document.getElementById(s.contentWrap):s.contentWrap;this.layoutRegions[o].el=l,this.layoutRegions[o].contentWrap=r}),this.beforeWindowResize=_.debounce(this.beforeWindowResize.bind(this),185.69),this.afterWindowResize=_.debounce(this.afterWindowResize.bind(this),585.69,!1)}get prevWindowSize(){return this._prevWindowSize}set prevWindowSize({width:e,height:i}){this._prevWindowSize={width:e,height:i}}get windowSize(){return this._windowSize}set windowSize({width:e,height:i}){this._windowSize={width:e,height:i}}start(e={isEditor:!1}){this.elementsCollection.comparator=(i,t)=>{this.elementsCollectionSortedCIDs||(this.elementsCollectionSortedCIDs=[...document.querySelectorAll("[data-lqd-model-cid]")].map(l=>l.getAttribute("data-lqd-model-cid")));const n=i.cid,o=t.cid;let s=0;return this.elementsCollectionSortedCIDs.indexOf(n)>this.elementsCollectionSortedCIDs.indexOf(o)?s=1:this.elementsCollectionSortedCIDs.indexOf(n)<this.elementsCollectionSortedCIDs.indexOf(o)&&(s=-1),s},this.elementsCollection.on("sort",()=>{this.elementsCollectionSortedCIDs=null}),this.topWrap=document.querySelector(this.topWrapSelector),this.buildElementsCollection(),this.addLayoutRegions(),_.defer(()=>{e.isEditor||(this.addBehaviors(),this.initializeBehaviors()),this.trigger("app:start",this)}),_.defer(()=>{this.bindWindowResize()}),_.defer(()=>{e.isEditor||(this.isStarted=!0)})}childrenComparator(e,i){const t=this.elementsCollection.map(l=>l.cid),n=e.cid,o=i.cid;let s=0;return t.indexOf(n)>t.indexOf(o)?s=1:t.indexOf(n)<t.indexOf(o)&&(s=-1),s}addLayoutRegions(){Object.entries(this.layoutRegions).forEach(([e,{el:i,contentWrap:t}])=>{const n=this.elementsCollection.where(c=>c.get("layoutRegion")===e),o=Backbone.Collection.extend({model:a}),s=new o(n),l=new p({childrenCollection:s}),r=new f({model:l,contentWrap:t,el:i});s.comparator=this.childrenComparator.bind(this),l.view=r,this.layoutRegions[e]=this.layoutRegions[e]||{},this.layoutRegions[e].model=l})}buildElementsCollection(){[...document.querySelectorAll(`${this.containersSelector}, ${this.widgetsSelector}`)].forEach(i=>this.buildElementModelAndView(i))}buildElementModelAndView(e,{region:i,sort:t=!1}={}){if(e.hasAttribute("data-lqd-model-cid"))return;const n=e.classList.contains(this.containersClassname),o=i||this.getElRegion(e),s=[],l={},r=new a({isContainer:n,layoutRegion:o,animatableElements:[e]}),c=new f({model:r,el:e});r.view=c,e.setAttribute("data-lqd-model-cid",r.cid),e.setAttribute("data-lqd-view-cid",c.cid),this.elementsCollection.add(r,{sort:t});const w=this.layoutRegions[o]?.model?.get("childrenCollection");w&&w.add(r,{sort:t});let h=e.parentElement?.closest(this.containersSelector);for(;h;)s.push(h),h=h?.parentElement?.closest(this.containersSelector);const m=this.getModelsOfElements(s,{layoutRegion:o,sort:t});if(m.length){const d=Backbone.Collection.extend({model:a});l.parentsCollection=new d(m),l.topParentContainer=m.at(-1)}if(n){const d=[...e.querySelectorAll(`${this.containersSelector}, ${this.widgetsSelector}`)],u=this.getModelsOfElements(d,{layoutRegion:o,sort:t}),g=Backbone.Collection.extend({model:a});l.childrenCollection=new g(u),l.isBoxed=e.classList.contains(this.containersBoxedClassname),l.childrenCollection.comparator=this.childrenComparator.bind(this),l.topParentContainer||(l.isTopLevelContainer=!0)}return r.set(l),l.parentsCollection&&l.parentsCollection.forEach(d=>{const u=d.get("childrenCollection");!u||u.add(r,{sort:t})}),r}getElRegion(e){const i=_.omit(this.layoutRegions,"liquidPageContent");let t="liquidPageContent";return Object.entries(i).forEach(([n,{contentWrap:o}])=>{if(!!o&&o.contains(e))return t=n}),t}getModelsOfElements(e=[],{layoutRegion:i,sort:t=!1}={}){let n=[];return e?.length&&(n=e.map(o=>this.elementsCollection.findWhere(s=>s.cid===o.getAttribute("data-lqd-model-cid"))||this.buildElementModelAndView(o,{layoutRegion:i,sort:t})).filter(o=>o&&o.view)),n}addToElementsCollection(e,{layoutRegion:i="liquidPageContent"}={}){this.buildElementModelAndView(e,{layoutRegion:i,sort:!0})}removeFromElementsCollection(e){if(!e)return;const i=e.getAttribute("data-lqd-model-cid"),t=this.elementsCollection.get(i);if(!t)return;this.elementsCollection.remove(t);const n=t.get("layoutRegion");this.elementsCollection.find(o=>{const s=o.get("parentsCollection"),l=o.get("childrenCollection");s?.forEach(r=>r?.get("childrenCollection")?.remove(t)),l?.remove(t)}),this.layoutRegions[n].model.get("childrenCollection").remove(t),t.view.destroy()}addBehaviors(){const e=[];[...this.elementsCollection.models].reverse().forEach(i=>{const t=window.liquid.behaviors?.filter(n=>n.el===i.view.el)?.flatMap(n=>n.behaviors);!t?.length||e.push({model:i,behaviorsArray:t})}),Object.entries(this.layoutRegions).forEach(([i,{behaviors:t,model:n}])=>{!t||e.push({model:n,behaviorsArray:t})}),this.constructBehaviors(e),window.liquid.behaviors=[]}addElementBehaviors(e,i,t=!1){if(!e||!i)return;const o=(t?Object.values(this.layoutRegions)?.map(s=>s.model):this.elementsCollection)?.find(s=>s.view.el===e);!o||(this.constructBehaviors([{model:o,behaviorsArray:i}]),this.initializeBehaviors())}constructBehaviors(e){[...e].sort((t,n)=>t.model.get("isContainer")-n.model.get("isContainer")).forEach(({model:t,behaviorsArray:n})=>{n.forEach(o=>{const s=new o.behaviorClass(t.view,o?.options||{}),l=t.get("behaviors")||[];t.set({behaviors:[...l,s]}),this.behaviorsInitializeQueue.push(s)})})}initializeBehaviors(){this.behaviorsInitializeQueue.forEach(e=>{!e.initializeHandledByEvents&&e.initialize(),this.behaviorsInitializeQueue=this.behaviorsInitializeQueue.filter((i,t)=>t>0)})}destroyElementBehaviors({el:e,model:i}={}){if(!(!e&&!i)){if(!i){const t=e.getAttribute("data-lqd-model-cid");i=this.elementsCollection.find(n=>n.cid===t)}!i||i.get("behaviors")?.forEach(t=>{t.destroy()})}}bindWindowResize(){window.addEventListener("resize",()=>{this.beforeWindowResize(),this.afterWindowResize()})}beforeWindowResize(){this.prevWindowSize=this.windowSize,this.trigger("before:windowResize",{prevSize:this.prevWindowSize,currentSize:this.windowSize})}afterWindowResize(){this.windowSize={width:window.innerWidth,height:window.innerHeight},this.trigger("after:windowResize",{prevSize:this.prevWindowSize,currentSize:this.windowSize})}destroy(){this.isStarted=!1,this.off(),this.stopListening(),this.layoutRegions={},this.elementsCollection=new C}}export default v;
